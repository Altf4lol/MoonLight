package wtf.moonlight.features.modules.impl.exploit;

import lombok.Getter;
import net.minecraft.client.gui.GuiDownloadTerrain;
import net.minecraft.client.gui.inventory.GuiInventory;
import net.minecraft.item.ItemStack;
import net.minecraft.network.INetHandler;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.*;
import net.minecraft.network.play.server.*;
import net.minecraft.potion.Potion;
import wtf.moonlight.MoonLight;
import wtf.moonlight.events.annotations.EventTarget;
import wtf.moonlight.events.impl.packet.PacketEvent;
import wtf.moonlight.events.impl.player.MotionEvent;
import wtf.moonlight.events.impl.player.UpdateEvent;
import wtf.moonlight.features.modules.Module;
import wtf.moonlight.features.modules.ModuleCategory;
import wtf.moonlight.features.modules.ModuleInfo;
import wtf.moonlight.features.values.impl.BoolValue;
import wtf.moonlight.features.values.impl.MultiBoolValue;
import wtf.moonlight.gui.notification.NotificationManager;
import wtf.moonlight.gui.notification.NotificationType;
import wtf.moonlight.utils.player.MovementUtils;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.concurrent.ConcurrentLinkedDeque;
import java.util.concurrent.CopyOnWriteArrayList;

@ModuleInfo(name = "Disabler", category = ModuleCategory.Exploit)
public class Disabler extends Module {

    public final MultiBoolValue options = new MultiBoolValue("Disablers", Arrays.asList(
            new BoolValue("Watchdog Motion", false),
            new BoolValue("Watchdog Inventory", false),
            new BoolValue("Matrix Semi", false),
            new BoolValue("GrimAC", false),
            new BoolValue("Intave Cloud",false)
    ), this);
    public final MultiBoolValue grim = new MultiBoolValue("Addons", Arrays.asList(new BoolValue("Post", false),
            new BoolValue("Speed Mine", false), new BoolValue("BadPackets F", false),
            new BoolValue("BadPackets G", false)), this, () -> options.isEnabled("GrimAC"));
    private int testTicks;
    private boolean jump = false;
    private boolean lastResult = false;
    public boolean disabled = false;
    @Getter
    private final CopyOnWriteArrayList<Packet<INetHandler>> storedPackets = new CopyOnWriteArrayList<>();
    @Getter
    private final ConcurrentLinkedDeque<Integer> pingPackets = new ConcurrentLinkedDeque<>();
    private boolean sprinting;
    private boolean sneaking;
    private boolean c16 = false;
    private boolean c0d = false;
    private double lastMotionX = 0.0;
    private double lastMotionY = 0.0;
    private double lastMotionZ = 0.0;
    private boolean pendingFlagApplyPacket = false;
    private final ArrayList<Packet> intaveP = new ArrayList();

    @Override
    public void onEnable() {
        testTicks = 0;
        jump = false;
        sprinting = false;
        sneaking = false;
    }

    @Override
    public void onDisable() {
    }

    @EventTarget
    public void onMotion(MotionEvent event) {
        if (options.isEnabled("Watchdog Motion")) {
            boolean compass = false;

            for (int i = 0; i < 9; i++) {
                final ItemStack stackInSlot = mc.thePlayer.inventory.getStackInSlot(i);

                if (stackInSlot != null && stackInSlot.getUnlocalizedName().toLowerCase().contains("compass")) {
                    compass = true;
                }
            }


            if (!compass) {
                if (mc.thePlayer.onGround && jump) {
                    jump = false;
                    disabled = true;
                    mc.thePlayer.jump();
                } else if (disabled && mc.thePlayer.offGroundTicks >= 3) {
                    if (mc.thePlayer.offGroundTicks % 2 == 0) {
                        event.setX(event.getX() + 0.095);
                    }
                    MovementUtils.stop();
                } else if(disabled){
                    MovementUtils.stop();
                }
            }
        }

        if (options.isEnabled("GrimAC")) {
            if (grim.isEnabled("Post")) {
                if (event.isPre() && !getPost()) {
                    processPackets();
                }
            }
        }
    }

    @EventTarget
    public void onUpdate(UpdateEvent event) {
        if (options.isEnabled("Watchdog Inventory")) {
            c16 = false;
            c0d = false;
            if (mc.currentScreen instanceof GuiInventory) {
                if (mc.thePlayer.ticksExisted % (mc.thePlayer.isPotionActive(Potion.moveSpeed) ? 3 : 4) == 0) {
                    sendPacketNoEvent(new C0DPacketCloseWindow());
                } else if (mc.thePlayer.ticksExisted % (mc.thePlayer.isPotionActive(Potion.moveSpeed) ? 3 : 4) == 1) {
                    sendPacketNoEvent(new C16PacketClientStatus(C16PacketClientStatus.EnumState.OPEN_INVENTORY_ACHIEVEMENT));
                }
            }
        }
    }

    @EventTarget
    public void onPacket(PacketEvent event) {
        if (mc.thePlayer == null) return;
        Packet packet = event.getPacket();

        if (packet instanceof S07PacketRespawn) {
            disabled = false;
            jump = true;
        }

        if (options.isEnabled("Watchdog Motion")) {
            if (event.getPacket() instanceof S08PacketPlayerPosLook) {
                testTicks++;
                if (testTicks == 30) {
                    mc.thePlayer.jump();
                    disabled = false;
                    testTicks = 0;
                    MoonLight.INSTANCE.getNotificationManager().post(NotificationType.OKAY, "Successfully Disabled Watchdog.", "Enjoy lowhopping yay", 3);
                }
                if (disabled) {
                    MoonLight.INSTANCE.getNotificationManager().post(NotificationType.WARNING, "Don't Move! ", "Disabling Motion Checks", 3);
                }
            }
        }

        if (options.isEnabled("Watchdog Inventory")) {

            if (event.getPacket() instanceof C16PacketClientStatus) {
                if (c16) {
                    event.setCancelled(true);
                }
                c16 = true;
            }

            if (event.getPacket() instanceof C0DPacketCloseWindow) {
                if (c0d) {
                    event.setCancelled(true);
                }
                c0d = true;
            }
        }

        if (options.isEnabled("GrimAC")) {
            if (packet instanceof C0BPacketEntityAction wrapped) {
                if (grim.isEnabled("BadPackets F")) {
                    if (wrapped.getAction() == C0BPacketEntityAction.Action.START_SPRINTING) {
                        if (sprinting)
                            event.setCancelled(true);

                        sprinting = true;
                    }

                    if (wrapped.getAction() == C0BPacketEntityAction.Action.STOP_SPRINTING) {
                        if (!sprinting)
                            event.setCancelled(true);

                        sprinting = false;
                    }
                }

                if (grim.isEnabled("BadPackets G")) {
                    if (wrapped.getAction() == C0BPacketEntityAction.Action.START_SNEAKING) {
                        if (sneaking)
                            event.setCancelled(true);

                        sneaking = true;
                    }

                    if (wrapped.getAction() == C0BPacketEntityAction.Action.STOP_SNEAKING) {
                        if (!sneaking)
                            event.setCancelled(true);

                        sneaking = false;
                    }
                }
            }
            if (grim.isEnabled("Speed Mine")) {
                if (packet instanceof C07PacketPlayerDigging wrapped) {
                    if (wrapped.getStatus() == C07PacketPlayerDigging.Action.STOP_DESTROY_BLOCK) {
                        sendPacketNoEvent(new C07PacketPlayerDigging(C07PacketPlayerDigging.Action.ABORT_DESTROY_BLOCK, wrapped.getPosition(), wrapped.getFacing()));
                    }
                }
            }
        }

        if (options.isEnabled("Matrix Semi")) {
            if (packet instanceof C03PacketPlayer.C06PacketPlayerPosLook && pendingFlagApplyPacket) {
                pendingFlagApplyPacket = false;
                mc.thePlayer.motionX = lastMotionX;
                mc.thePlayer.motionY = lastMotionY;
                mc.thePlayer.motionZ = lastMotionZ;
            } else if (packet instanceof S08PacketPlayerPosLook) {
                pendingFlagApplyPacket = true;
                lastMotionX = mc.thePlayer.motionX;
                lastMotionY = mc.thePlayer.motionY;
                lastMotionZ = mc.thePlayer.motionZ;
            }
        }

        if (options.isEnabled("Intave Cloud")) {
            if (packet instanceof C0FPacketConfirmTransaction) {
                event.setCancelled(true);
                intaveP.add(event.getPacket());
            }

            while (this.intaveP.size() > 50) {
                mc.getNetHandler().getNetworkManager().sendPacketNoEvent(intaveP.get(0));
                intaveP.remove(0);
            }

        }
    }

    public boolean postDelay(Packet<?> packet) {
        if (mc.thePlayer == null && !isEnabled(this.getClass())) {
            return false;
        }
        if (packet instanceof S12PacketEntityVelocity velocityPacket) {
            return velocityPacket.getEntityID() == mc.thePlayer.getEntityId();
        } else return packet instanceof S32PacketConfirmTransaction ||
                packet instanceof S22PacketMultiBlockChange ||
                packet instanceof S04PacketEntityEquipment ||
                packet instanceof S08PacketPlayerPosLook ||
                packet instanceof S06PacketUpdateHealth ||
                packet instanceof S23PacketBlockChange ||
                packet instanceof S27PacketExplosion ||
                packet instanceof S00PacketKeepAlive ||
                packet instanceof S0FPacketSpawnMob ||
                packet instanceof S14PacketEntity;
    }

    public void processPackets() {
        if (options.isEnabled("GrimAC")) {
            if (!storedPackets.isEmpty()) {
                for (Packet<INetHandler> packet : storedPackets) {
                    PacketEvent event = new PacketEvent(packet, PacketEvent.State.INCOMING);

                    INSTANCE.getEventManager().call(event);

                    if (!event.isCancelled()) {
                        packet.processPacket(mc.getNetHandler());
                    }
                }
                storedPackets.clear();
            }
        }
    }

    public boolean getPost() {
        boolean result = mc.thePlayer != null && mc.thePlayer.isEntityAlive() && mc.thePlayer.ticksExisted >= 10 && !(mc.currentScreen instanceof GuiDownloadTerrain);
        if (this.lastResult && !result) {
            this.lastResult = false;
            mc.addScheduledTask(this::processPackets);
        }
        return this.lastResult = result;
    }
}